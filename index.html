<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Word Learning Demo</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; max-width: 820px; margin: 40px auto; padding: 0 16px; }
    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    input, button, select { font-size: 16px; padding: 8px 10px; }
    button { cursor: pointer; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 16px; margin: 16px 0; }
    .muted { color: #666; }
    .ok { color: #0a7a0a; font-weight: 600; }
    .bad { color: #b00020; font-weight: 600; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border-bottom: 1px solid #eee; padding: 8px; text-align: left; }
    th { background: #fafafa; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; border: 1px solid #ddd; font-size: 12px; }
  </style>
</head>
<body>
  <h1>Word Learning Demo</h1>

  <div class="card">
    <div class="row">
      <label>
        Username:
        <input id="username" value="web_user" />
      </label>

      <label>
        Language:
        <select id="language">
          <option value="fr" selected>French (fr)</option>
        </select>
      </label>

      <button id="startBtn">Start</button>
      <span class="muted" id="status"></span>
    </div>
  </div>

  <div class="card" id="quizCard" style="display:none;">
    <div class="row" style="justify-content: space-between;">
      <div>
        <div class="muted">Topic: <span id="topic">—</span></div>
        <div class="muted">User ID: <span id="userId">—</span></div>
      </div>
      <div class="pill">Q <span id="qNum">1</span></div>
    </div>

    <h2 style="margin-top: 12px;">
      Translate: <span id="prompt">—</span>
    </h2>

    <div class="row">
      <input id="answerInput" placeholder="Type your answer…" autocomplete="off" />
      <button id="submitBtn">Submit</button>
    </div>

    <div style="margin-top: 10px;" id="feedback"></div>
  </div>

    <div class="card" id="lessonSummary" style="display:none;">
        <h2>Lesson summary</h2>
        <div class="muted">Sorted weakest → strongest</div>
        <div id="summaryMeta" class="muted" style="margin: 8px 0;"></div>

        <table>
            <thead>
                <tr>
                    <th>Prompt</th>
                    <th>Answer</th>
                    <th>Mastery</th>
                    <th>Attempts</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="summaryBody"></tbody>
        </table>

        <h3>AI patterns (this lesson)</h3>
        <ul id="patternsLesson"></ul>

        <h3>AI patterns (lifetime)</h3>
        <ul id="patternsLife"></ul>
    </div>

  <script>
    // ====== CONFIG ======
    const API_BASE = "http://127.0.0.1:8000"; // change if needed

    // ====== STATE ======
    let userId = null;
    let currentWordId = null;
    let qNum = 1;
    let topic = null;

    // ====== DOM ======
    const statusEl = document.getElementById("status");
    const startBtn = document.getElementById("startBtn");
    const submitBtn = document.getElementById("submitBtn");
    const usernameEl = document.getElementById("username");
    const languageEl = document.getElementById("language");

    const quizCard = document.getElementById("quizCard");
    const topicEl = document.getElementById("topic");
    const userIdEl = document.getElementById("userId");
    const qNumEl = document.getElementById("qNum");
    const promptEl = document.getElementById("prompt");
    const answerInputEl = document.getElementById("answerInput");
    const feedbackEl = document.getElementById("feedback");

    const lessonSummaryEl = document.getElementById("lessonSummary");
    const summaryMetaEl = document.getElementById("summaryMeta");
    const summaryBodyEl = document.getElementById("summaryBody");

    const patternsLessonEl = document.getElementById("patternsLesson");
    const patternsLifeEl = document.getElementById("patternsLife");

    // ====== HELPERS ======
    async function postJson(path, body) {
      const res = await fetch(API_BASE + path, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      if (!res.ok) {
        const text = await res.text();
        throw new Error(`HTTP ${res.status}: ${text}`);
      }
      return await res.json();
    }

    function setStatus(msg) {
      statusEl.textContent = msg;
    }

    function showFeedback({score, correct_answer, mastery, was_exact_match}) {
      const pct = Math.round(score * 100);
      const masteryPct = Math.round(mastery * 100);
      if (was_exact_match) {
        feedbackEl.innerHTML =
          `<div class="ok">✅ Correct!</div>
           <div class="muted">Score: ${pct}% • Mastery: ${masteryPct}%</div>`;
      } else {
        feedbackEl.innerHTML =
          `<div class="bad">❌ Not quite.</div>
           <div class="muted">Correct: <b>${correct_answer}</b> • Score: ${pct}% • Mastery: ${masteryPct}%</div>`;
      }
    }

    function renderPatterns(el, patterns) {
        el.innerHTML = "";
        if (!patterns || patterns.length === 0) {
            const li = document.createElement("li");
            li.textContent = "(none)";
            el.appendChild(li);
            return;
           }
            for (const item of patterns) {
            // item might be ["del:e", 2] or {feature:"del:e", count:2}
             let feat, cnt;
             if (Array.isArray(item)) {
                [feat, cnt] = item;
            } else {
                feat = item.feature;
                cnt = item.count;
            }
            const li = document.createElement("li");
            li.textContent = `${feat}: ${cnt}`;
            el.appendChild(li);
           }
          }

   function renderLessonSummary(lessonMastery, targetMastery, patternsLesson, patternsLife) {
        lessonSummaryEl.style.display = "block";
        summaryBodyEl.innerHTML = "";

        for (const row of lessonMastery) {
            const masteryPct = Math.round(row.mastery * 100);

            let status = "";
            if (row.attempts === 0) status = "Not seen";
            else if (row.mastery >= targetMastery) status = "On target";
            else status = "Below target";

            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${row.prompt}</td>
                <td>${row.answer}</td>
                <td>${masteryPct}%</td>
                <td>${row.attempts}</td>
                <td>${status}</td>
    `           ;
            summaryBodyEl.appendChild(tr);
           }

           summaryMetaEl.textContent = `Target mastery: ${Math.round(targetMastery * 100)}%`;

             // Render patterns under the table
            renderPatterns(patternsLessonEl, patternsLesson);
            renderPatterns(patternsLifeEl, patternsLife);
           }

    function hideLessonSummary() {
        lessonSummaryEl.style.display = "none";
        summaryBodyEl.innerHTML = "";
        summaryMetaEl.textContent = "";
        patternsLessonEl.innerHTML = "";
        patternsLifeEl.innerHTML = "";
        }



    // ====== ACTIONS ======
    startBtn.addEventListener("click", async () => {
      try {
        setStatus("Starting...");
        hideLessonSummary();
        feedbackEl.textContent = "";

        const username = usernameEl.value.trim() || "web_user";
        const language_code = languageEl.value;

        const data = await postJson("/start", { username, language_code });

        if (data.error) {
          setStatus(data.error);
          return;
        }


        userId = data.user_id;
        topic = data.topic;
        currentWordId = data.question.word_id;
        qNum = data.question_number || 1;

        // Update UI
        quizCard.style.display = "block";
        topicEl.textContent = topic;
        userIdEl.textContent = userId;
        qNumEl.textContent = qNum;
        promptEl.textContent = data.question.prompt;

        answerInputEl.value = "";
        answerInputEl.focus();

        setStatus("Ready.");
      } catch (e) {
        setStatus("Error starting: " + e.message);
        console.error(e);
      }
    });

    submitBtn.addEventListener("click", async () => {
      try {
        if (userId == null || currentWordId == null) {
          setStatus("Click Start first.");
          return;
        }

        const user_answer = answerInputEl.value.trim();
        if (!user_answer) {
          setStatus("Please type an answer.");
          return;
        }

        setStatus("Submitting...");
        const language_code = languageEl.value;

        const data = await postJson("/answer", {
          user_id: userId,
          word_id: currentWordId,
          user_answer,
          language_code
        });

        if (data.error) {
          setStatus(data.error);
          return;
        }
        if (!data.lesson_complete) hideLessonSummary();
        // Lesson summary only when lesson_complete is true
        if (data.lesson_complete && Array.isArray(data.lesson_mastery) && data.lesson_mastery.length > 0) {
            renderLessonSummary(
                data.lesson_mastery,
                data.target_mastery ?? 0.9,
                data.learned_patterns_this_lesson ?? [],
                data.learned_patterns_lifetime ?? []
               );
        }

        // Per-question feedback
        showFeedback({
          score: data.result.score,
          correct_answer: data.result.correct_answer,
          mastery: data.result.mastery,
          was_exact_match: data.result.was_exact_match
        });

        // Update topic if it unlocked
        if (data.topic) topic = data.topic;
        topicEl.textContent = topic;

        // Next question
        const nq = data.next_question;
        currentWordId = nq.word_id;
        promptEl.textContent = nq.prompt;

        // If API returns question_number, prefer it; otherwise increment locally
        if (typeof data.question_number === "number") {
          qNum = data.question_number;
        } else {
          qNum += 1;
        }
        qNumEl.textContent = qNum;

        // Prepare for next answer
        answerInputEl.value = "";
        answerInputEl.focus();

        setStatus("Ready.");
      } catch (e) {
        setStatus("Error submitting: " + e.message);
        console.error(e);
      }
    });

    // Enter key submits
    answerInputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter") submitBtn.click();
    });
  </script>
</body>
</html>
